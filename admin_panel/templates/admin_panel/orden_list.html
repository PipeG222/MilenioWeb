{% extends 'admin_panel/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Órdenes | Panel Administrativo{% endblock %}

{% block header_title %}Órdenes{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filtros</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-12">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Buscar por cliente, empleado, tipo..." name="q" value="{{ search_query }}">
                            <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
                            {% if search_query or estado_filter or tipo_filter or fecha_desde or fecha_hasta %}
                            <a href="{% url 'admin_panel:orden_list' %}" class="btn btn-outline-danger"><i class="fas fa-times"></i> Limpiar</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select" id="estado" name="estado">
                            <option value="">Todos los estados</option>
                            {% for value, text in estado_opciones %}
                            <option value="{{ value }}" {% if estado_filter == value %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-select" id="tipo" name="tipo">
                            <option value="">Todos los tipos</option>
                            {% for value, text in tipo_opciones %}
                            <option value="{{ value }}" {% if tipo_filter == value %}selected{% endif %}>{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fecha_desde" class="form-label">Desde</label>
                        <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde }}">
                    </div>
                    <div class="col-md-3">
                        <label for="fecha_hasta" class="form-label">Hasta</label>
                        <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta }}">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-1"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'admin_panel:orden_create' %}" class="btn btn-primary mb-3 w-100">
            <i class="fas fa-plus me-1"></i> Nueva Orden
        </a>
        <div class="btn-group w-100">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-file-export me-1"></i> Exportar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Excel</a></li>
                <li><a class="dropdown-item" href="#">PDF</a></li>
                <li><a class="dropdown-item" href="#">CSV</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lista de Órdenes</h5>
            <span class="badge bg-primary">{{ paginator.count }} órdenes encontradas</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Empleado</th>
                        <th>Fecha</th>
                        <th>Tipo de Servicio</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orden in ordenes %}
                    <tr>
                        <td>{{ orden.id }}</td>
                        <td>{{ orden.usuario.nombre }}</td>
                        <td>{{ orden.empleado.nombre }}</td>
                        <td>{{ orden.fecha_inicio }}</td>
                        <td>
                            {% if orden.tipo_orden %}
                                {{ orden.get_tipo_orden_display }}
                            {% else %}
                                {{ orden.tipo_servicio }}
                            {% endif %}
                        </td>
                        <td>
                            {% if orden.estado_envio == 'completado' %}
                            <span class="badge bg-success">Completado</span>
                            {% elif orden.estado_envio == 'pendiente' %}
                            <span class="badge bg-warning text-dark">Pendiente</span>
                            {% elif orden.estado_envio == 'en_proceso' %}
                            <span class="badge bg-primary">En Proceso</span>
                            {% elif orden.estado_envio == 'cancelado' %}
                            <span class="badge bg-danger">Cancelado</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ orden.estado_envio }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'admin_panel:orden_detail' orden.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'admin_panel:orden_update' orden.id %}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'admin_panel:orden_delete' orden.id %}" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">No hay órdenes registradas que coincidan con los filtros.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if is_paginated %}
    <div class="card-footer">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&laquo; Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo; Primera</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Anterior</span>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if tipo_filter %}&tipo={{ tipo_filter }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">Última &raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Siguiente</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Última &raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %} 